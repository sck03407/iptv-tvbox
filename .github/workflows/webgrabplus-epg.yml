name: 'Generate Custom EPG'

on:
  workflow_dispatch:
  schedule:
    - cron: '0 20 * * 0' # UTC Sunday 20:00 -> Beijing Monday 04:00 (Weekly)

permissions:
  contents: write

concurrency:
  group: generate-epg-${{ github.ref }}
  cancel-in-progress: true

jobs:
  generate-epg:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4
      - name: Sync with remote
        run: git pull --rebase
      - name: Checkout SiteIni Pack (Upstream)
        uses: actions/checkout@v4
        with:
          repository: SilentButeo2/webgrabplus-siteinipack
          path: upstream_siteini
          sparse-checkout: |
            siteini.pack/China
        continue-on-error: true
      
      - name: Sync SiteIni Pack to Local
        run: |
          # If upstream checkout failed (e.g. repo deleted), we skip sync and use local cache
          if [ -d "upstream_siteini/siteini.pack/China" ]; then
            echo "Upstream found, syncing..."
            # Create local storage directory
            mkdir -p config/webgrabplus/siteini.pack/China
            
            # Sync files from upstream to local repo storage
            rsync -a --delete upstream_siteini/siteini.pack/China/ config/webgrabplus/siteini.pack/China/
            
            # Clean up upstream checkout
            rm -rf upstream_siteini
          else
            echo "Upstream not found or checkout failed, using local cache."
            if [ ! -d "config/webgrabplus/siteini.pack/China" ]; then
               echo "Error: No local cache found either. Cannot proceed."
               exit 1
            fi
          fi
          
      - name: Run with setup-python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          update-environment: true
      
      - name: Generate WebGrab++.config.xml
        run: |
          python scripts/generate_epg_config.py
      - name: Run WebGrab+Plus
        run: |
          chmod -R 777 output
          mkdir -p output/epg
          if ls config/webgrabplus/siteini.pack/China/*.ini 1> /dev/null 2>&1; then
            cp config/webgrabplus/siteini.pack/China/*.ini config/webgrabplus/
          fi
          
          docker run --rm \
            --hostname webgrabplus \
            --mac-address 02:42:ac:11:00:02 \
            --cap-add=NET_ADMIN \
            --dns 223.5.5.5 \
            --dns 119.29.29.29 \
            -e PUID=1000 \
            -e PGID=1000 \
            -e TZ=Asia/Shanghai \
            -v ${{ github.workspace }}/config/webgrabplus:/config \
            -v ${{ github.workspace }}/output:/data \
            lscr.io/linuxserver/webgrabplus:latest \
            /bin/bash -c "set -e; \
              echo 'diag: installing iptables for network spoofing'; \
              if command -v apk >/dev/null; then apk add --no-cache iptables; \
              elif command -v apt-get >/dev/null; then apt-get update && apt-get install -y iptables; \
              else echo 'No package manager found'; fi; \
              echo 'diag: applying iptables NAT rule to redirect all ICMP ping to localhost'; \
              iptables -t nat -A OUTPUT -p icmp --icmp-type echo-request -j DNAT --to-destination 127.0.0.1 || echo 'Failed to apply iptables rule'; \
              echo 'diag: verifying ping spoof (should succeed locally)'; ping -c 1 webgrabplus.com || echo 'Ping still failed'; \
              echo 'diag: verifying http access (should succeed remotely)'; curl -I -m 5 https://webgrabplus.com || echo 'HTTP failed'; \
              echo 'diag: running webgrabplus...'; \
              if [ -x /app/dotnet/dotnet ] && [ -f /app/wg++/bin.net/WebGrab+Plus.dll ]; then \
                /app/dotnet/dotnet /app/wg++/bin.net/WebGrab+Plus.dll /config; \
              elif [ -x /usr/bin/dotnet ] && [ -f /app/wg++/bin.net/WebGrab+Plus.dll ]; then \
                dotnet /app/wg++/bin.net/WebGrab+Plus.dll /config; \
              else \
                echo \"WebGrab+Plus executable not found\"; ls -la /app /app/wg++ /app/wg++/bin.net || true; exit 1; \
              fi"
          if [ ! -f output/epg/custom_epg.xml ]; then
            echo "custom_epg.xml not generated"
            if [ -f config/webgrabplus/WebGrab++.log.txt ]; then
              tail -n 200 config/webgrabplus/WebGrab++.log.txt
            fi
            exit 1
          fi
            
      - name: Commit and push if changed
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git config --global advice.addIgnoredFile false
          # Add the synced siteini pack files to git
          git add config/webgrabplus/siteini.pack/China/*
          git add config/webgrabplus/WebGrab++.config.xml || true
          git add output/epg/custom_epg.xml || true
          if ! git diff --staged --quiet; then
            git commit -m "Update custom EPG and sync SiteIni Pack"
            git push
          fi
